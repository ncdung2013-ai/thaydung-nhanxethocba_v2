<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tr·ª£ l√Ω Nh·∫≠n x√©t H·ªçc b·∫° (Phi√™n b·∫£n ch·∫°y ngay)</title>
    
    <!-- 1. T·∫¢I C√ÅC TH∆Ø VI·ªÜN C·∫¶N THI·∫æT T·ª™ CDN (Server l∆∞u tr·ªØ qu·ªëc t·∫ø) -->
    <!-- Tailwind CSS (Giao di·ªán) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (Core) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Excel & PDF Tools -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Babel (D·ªãch code React ngay tr√™n tr√¨nh duy·ªát) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- C·∫•u h√¨nh Giao di·ªán -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: { primary: '#0F52BA', secondary: '#E1E8F0' },
            animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
            keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
          }
        }
      }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .cursor-wait { cursor: wait; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "path": "https://esm.sh/path@^0.12.7",
    "vite": "https://esm.sh/vite@^7.3.1",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2",
    "@google/genai": "https://esm.sh/@google/genai@^1.35.0",
    "jspdf": "https://esm.sh/jspdf@^4.0.0",
    "html2canvas": "https://esm.sh/html2canvas@^1.4.1",
    "xlsx": "https://esm.sh/xlsx@^0.18.5"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <!-- 2. C·∫¶U N·ªêI AI: T·∫£i th∆∞ vi·ªán Google GenAI ri√™ng bi·ªát -->
    <script type="module">
        import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@0.1.1";
        // G√°n v√†o bi·∫øn to√†n c·ª•c ƒë·ªÉ React d√πng ƒë∆∞·ª£c
        window.GoogleGenAI = GoogleGenAI;
        window.GoogleGenAIType = Type;
    </script>

    <!-- 3. CODE ·ª®NG D·ª§NG CH√çNH (React) -->
    <script type="text/babel">
        // L·∫•y c√°c th∆∞ vi·ªán ƒë√£ t·∫£i ·ªü tr√™n ra d√πng
        const { useState, useEffect, useRef, useCallback } = React;
        const XLSX = window.XLSX;
        const html2canvas = window.html2canvas;
        const { jsPDF } = window.jspdf;

        // ƒê·ªãnh nghƒ©a c√°c h·∫±ng s·ªë (Thay cho Enum)
        const TeacherRole = {
            SUBJECT: 'GVBM',
            HOMEROOM: 'GVCN'
        };

        // --- C√ÅC H√ÄM X·ª¨ L√ù LOGIC (SERVICES) ---

        // 1. X·ª≠ l√Ω Excel/Text
        const isNamePart = (val) => {
            if (typeof val !== 'string') return false;
            const str = val.trim();
            if (str.length === 0) return false;
            if (/\d/.test(str)) return false; 
            if (str.length < 2 && str.toUpperCase() !== '√ù') return false;
            const keywords = [
                'stt', 'h·ªç', 't√™n', 'th·ª©', 'ng√†y', 'th√°ng', 'nƒÉm', 'l·ªõp', 'tr∆∞·ªùng', 
                'd√¢n', 't·ªôc', 'n·ªØ', 'nam', 'ƒëi·ªÉm', 'trung', 'b√¨nh', 'x·∫øp', 'lo·∫°i',
                'ghi', 'ch√∫', 'k·∫øt', 'qu·∫£', 'h·ªçc', 'k·ª≥', 'm√¥n', 
                'gdcd', 'c√¥ng', 'ngh·ªá', 'tin', 'th·ªÉ', 'gi√°o', 'vi√™n', 'tbm', 'ƒëtb', 
                'ubnd', 'thcs', 'thpt', 'ph√≤ng', 's·ªü', 'ƒë√†o', 't·∫°o', 'c·ªông', 'h√≤a',
                'x√£', 'huy·ªán', 't·ªânh', 'th√†nh', 'ph·ªë', 'ƒë·ªôc', 'l·∫≠p', 't·ª±', 'do',
                's·ªë', 'l∆∞·ª£ng', 't·ªâ', 'l·ªá', 't·ªïng', 'sinh', 'ƒë·∫°t', 'ch∆∞a'
            ];
            const lower = str.toLowerCase();
            if (keywords.some(k => lower === k)) return false;
            if (['tr∆∞·ªùng', 'ph√≤ng', '·ªßy', 'ban', 'c·ªông h√≤a'].some(k => lower.includes(k))) return false;
            if (/^(T|K|TB|Y|G|ƒê|Cƒê|TX\d|HK\d)$/.test(str.toUpperCase())) return false;
            return true;
        };

        const detectSubject = (headers) => {
            const flatHeaders = headers.flat().join(' ').toLowerCase();
            if (flatHeaders.includes('to√°n')) return 'To√°n';
            if (flatHeaders.includes('vƒÉn') || flatHeaders.includes('vi·ªát') || flatHeaders.includes('ng·ªØ')) return 'VƒÉn';
            if (flatHeaders.includes('l·ªãch s·ª≠') || flatHeaders.includes('ƒë·ªãa l√Ω') || flatHeaders.includes('s·ª≠') || flatHeaders.includes('ƒë·ªãa')) return 'LS & ƒêL';
            if (flatHeaders.includes('khtn') || flatHeaders.includes('l√Ω') || flatHeaders.includes('h√≥a') || flatHeaders.includes('sinh')) return 'KHTN';
            if (flatHeaders.includes('tin')) return 'Tin h·ªçc';
            if (flatHeaders.includes('anh') || flatHeaders.includes('ngo·∫°i ng·ªØ')) return 'Ng.ng·ªØ';
            if (flatHeaders.includes('gdcd') || flatHeaders.includes('c√¥ng d√¢n')) return 'GDCD';
            if (flatHeaders.includes('c√¥ng ngh·ªá')) return 'C.ngh·ªá';
            if (flatHeaders.includes('th·ªÉ') || flatHeaders.includes('gdtc')) return 'GDTC';
            if (flatHeaders.includes('nh·∫°c') || flatHeaders.includes('m·ªπ thu·∫≠t') || flatHeaders.includes('ngh·ªá thu·∫≠t')) return 'Ngh·ªá thu·∫≠t';
            if (flatHeaders.includes('ƒë·ªãa ph∆∞∆°ng') || flatHeaders.includes('ndgdcƒëp')) return 'NDGDCƒêP';
            if (flatHeaders.includes('tr·∫£i nghi·ªám') || flatHeaders.includes('h∆∞·ªõng nghi·ªáp') || flatHeaders.includes('hƒëtn')) return 'HƒêTN&HN';
            return undefined;
        };

        const parseExcelData = (fileData, role) => {
            try {
                let workbook = (typeof fileData === 'string') 
                    ? XLSX.read(fileData, { type: 'string' }) 
                    : XLSX.read(fileData, { type: 'array' });

                if (!workbook.SheetNames || workbook.SheetNames.length === 0) return { students: [] };
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (!rawData || rawData.length === 0) return { students: [] };

                const headerRows = rawData.slice(0, 5);
                const detectedSubject = detectSubject(headerRows);
                const students = [];

                rawData.forEach((row, rowIndex) => {
                    if (!Array.isArray(row) || row.length === 0) return;
                    
                    // T√¨m t√™n h·ªçc sinh
                    let nameParts = [];
                    let nameEndIndex = -1;
                    
                    // Skip rows that look like headers based on first cell being text and not number
                    const firstCell = row[0];
                    let hasIndex = typeof firstCell === 'number' || (typeof firstCell === 'string' && /^\d+$/.test(firstCell.trim()));

                    for (let i = 0; i < row.length; i++) {
                        const cell = row[i];
                        if (nameParts.length === 0 && hasIndex && i === 0) continue; // Skip STT column

                        if (isNamePart(cell)) {
                            nameParts.push(String(cell).trim());
                            nameEndIndex = i;
                        } else if (nameParts.length > 0 && (cell === undefined || cell === null || String(cell).trim() === '')) {
                            const nextCell = row[i+1];
                            if (!isNamePart(nextCell)) break; 
                        } else if (nameParts.length > 0) {
                            break;
                        }
                    }

                    const fullName = nameParts.join(' ').trim();
                    if (!fullName || fullName.length < 2) if (fullName !== '√ù') return;
                    
                    const upperName = fullName.toUpperCase();
                    if (upperName.includes("TR∆Ø·ªúNG") || upperName.includes("THCS") || upperName.includes("S·ªê L∆Ø·ª¢NG") || upperName.includes("T·ªîNG C·ªòNG")) return;

                    let subjectScore, subjectRating, academicResult, conductRating, absences;

                    if (role === TeacherRole.SUBJECT) {
                        for (let j = row.length - 1; j > nameEndIndex; j--) {
                            const cell = row[j];
                            if (cell == null || String(cell).trim() === '') continue;
                            const cellStr = String(cell).trim().replace(',', '.');
                            const cellNum = parseFloat(cellStr);
                            if (!isNaN(cellNum)) {
                                if (cellNum >= 0 && cellNum <= 10) { subjectScore = cellNum; break; }
                            } else {
                                const upper = cellStr.toUpperCase();
                                if (/^(T|K|ƒê|Cƒê|TB|G|Y|ƒê·∫†T|CH∆ØA ƒê·∫†T)$/.test(upper)) { subjectRating = upper; break; }
                            }
                        }
                    } else {
                        const ratingsFound = [];
                        for (let j = nameEndIndex + 1; j < row.length; j++) {
                            const cell = row[j];
                            if (cell == null || String(cell).trim() === '') continue;
                            const str = String(cell).trim().toUpperCase();
                            if (/^(T|K|ƒê|Cƒê|G|TB|Y|T·ªêT|KH√Å|ƒê·∫†T|CH∆ØA ƒê·∫†T|GI·ªéI|Y·∫æU|TRUNG B√åNH|K√âM)$/.test(str)) {
                                ratingsFound.push(str);
                            } else if (/^\d+$/.test(str)) {
                                const n = parseInt(str, 10);
                                if (n >= 0 && n < 60) absences = n;
                            }
                        }
                        if (ratingsFound.length >= 2) {
                            academicResult = ratingsFound[0];
                            conductRating = ratingsFound[1];
                        } else if (ratingsFound.length === 1) {
                            academicResult = ratingsFound[0];
                        }
                    }

                    const hasData = (role === TeacherRole.SUBJECT) 
                        ? (subjectScore !== undefined || subjectRating !== undefined)
                        : (academicResult !== undefined || conductRating !== undefined || absences !== undefined);

                    if (!hasIndex && !hasData) return;

                    students.push({
                        id: `student-xls-${Date.now()}-${rowIndex}`,
                        name: fullName,
                        comment: '',
                        isProcessing: false,
                        subjectScore, subjectRating, academicResult, conductRating, absences
                    });
                });

                return { students, detectedSubject };
            } catch (e) {
                console.error("Excel Error:", e);
                return { students: [] };
            }
        };

        // 2. X·ª≠ l√Ω AI (Gemini)
        const getStoredKey = () => localStorage.getItem('GEMINI_API_KEY') || "";
        
        const getAIClient = (key) => {
            const apiKey = key || getStoredKey();
            if (!apiKey) throw new Error("MISSING_API_KEY");
            if (!window.GoogleGenAI) throw new Error("AI_LIB_NOT_LOADED");
            return new window.GoogleGenAI({ apiKey });
        };

        const CANDIDATE_MODELS = [
            "gemini-2.0-flash",
            "gemini-2.0-flash-lite-preview-02-05", 
            "gemini-1.5-flash", 
            "gemini-flash-latest"
        ];

        const testApiConnection = async (apiKey) => {
            if (!window.GoogleGenAI) throw new Error("Th∆∞ vi·ªán AI ch∆∞a t·∫£i xong. Vui l√≤ng t·∫£i l·∫°i trang.");
            const ai = new window.GoogleGenAI({ apiKey });
            let lastError = null;
            for (const model of CANDIDATE_MODELS) {
                try {
                    await ai.models.generateContent({ model: model, contents: "Hello" });
                    localStorage.setItem('GEMINI_ACTIVE_MODEL', model);
                    return true;
                } catch (e) {
                    lastError = e;
                    if (e.message && (e.message.includes("400") || e.message.includes("KEY"))) throw e;
                }
            }
            throw lastError;
        };

        const extractDataFromMedia = async (base64Data, mimeType, role) => {
            const ai = getAIClient();
            const modelName = localStorage.getItem('GEMINI_ACTIVE_MODEL') || CANDIDATE_MODELS[0];
            const prompt = role === TeacherRole.SUBJECT 
                ? "Tr√≠ch xu·∫•t danh s√°ch h·ªçc sinh t·ª´ b·∫£ng ƒëi·ªÉm n√†y: T√™n m√¥n h·ªçc, H·ªç t√™n, ƒêi·ªÉm t·ªïng k·∫øt (ho·∫∑c x·∫øp lo·∫°i). JSON format."
                : "Tr√≠ch xu·∫•t danh s√°ch h·ªçc sinh: H·ªç t√™n, KQHT, KQRL, S·ªë ng√†y ngh·ªâ. JSON format.";

            const Type = window.GoogleGenAIType;
            const responseSchema = {
                type: Type.OBJECT,
                properties: {
                    subjectName: { type: Type.STRING, nullable: true },
                    students: {
                        type: Type.ARRAY,
                        items: {
                            type: Type.OBJECT,
                            properties: {
                                name: { type: Type.STRING },
                                score: { type: Type.NUMBER, nullable: true },
                                rating: { type: Type.STRING, nullable: true },
                                kqht: { type: Type.STRING, nullable: true },
                                kqrl: { type: Type.STRING, nullable: true },
                                absences: { type: Type.NUMBER, nullable: true }
                            },
                            required: ["name"]
                        }
                    }
                },
                required: ["students"]
            };

            const response = await ai.models.generateContent({
                model: modelName,
                contents: { parts: [{ inlineData: { mimeType, data: base64Data } }, { text: prompt }] },
                config: { responseMimeType: "application/json", responseSchema: responseSchema }
            });

            const rawData = JSON.parse(response.text);
            const students = (rawData.students || []).map((item, idx) => ({
                id: `img-${Date.now()}-${idx}`,
                name: item.name,
                subjectScore: item.score,
                subjectRating: item.rating,
                academicResult: item.kqht,
                conductRating: item.kqrl,
                absences: item.absences,
                comment: '',
                isProcessing: false
            }));
            
            return { students, detectedSubject: rawData.subjectName };
        };

        const generateCommentsBatch = async (students, role, subjectName) => {
            const ai = getAIClient();
            const modelName = localStorage.getItem('GEMINI_ACTIVE_MODEL') || CANDIDATE_MODELS[0];
            const wordLimit = role === TeacherRole.SUBJECT ? 12 : 20;
            
            let systemInstruction = `B·∫°n l√† gi√°o vi√™n. Vi·∫øt nh·∫≠n x√©t h·ªçc b·∫° ng·∫Øn g·ªçn (T·ªëi ƒëa ${wordLimit} t·ª´).`;
            if (role === TeacherRole.SUBJECT) {
                systemInstruction += ` M√¥n ${subjectName}. Quy t·∫Øc: Gi·ªèi/T·ªët: Khen nƒÉng l·ª±c. Kh√°: Khen c·ªë g·∫Øng. TB: Nh·∫Øc chƒÉm ch·ªâ. Y·∫øu: Nh·∫Øc √¥n t·∫≠p.`;
            } else {
                systemInstruction += ` Vai tr√≤ GVCN. Quy t·∫Øc: T·ªët: Khen ngoan. Kh√°: Khen ph·∫•n ƒë·∫•u. C·∫ßn c·ªë g·∫Øng: Nh·∫Øc nh·ªü. Chuy√™n c·∫ßn: Nh·∫Øc n·∫øu ngh·ªâ nhi·ªÅu.`;
            }

            const Type = window.GoogleGenAIType;
            const outputSchema = {
                type: Type.ARRAY,
                items: {
                    type: Type.OBJECT,
                    properties: { id: { type: Type.STRING }, comment: { type: Type.STRING } },
                    required: ["id", "comment"]
                }
            };

            const payload = students.map(s => role === TeacherRole.SUBJECT 
                ? { id: s.id, name: s.name, result: s.subjectScore ?? s.subjectRating }
                : { id: s.id, name: s.name, kqht: s.academicResult, kqrl: s.conductRating, absences: s.absences }
            );

            const response = await ai.models.generateContent({
                model: modelName,
                contents: JSON.stringify(payload),
                config: {
                    systemInstruction: systemInstruction,
                    responseMimeType: "application/json",
                    responseSchema: outputSchema,
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                }
            });

            const results = JSON.parse(response.text);
            const map = new Map();
            if (Array.isArray(results)) results.forEach(r => map.set(r.id, r.comment));
            return map;
        };

        // --- COMPONENTS ---

        // 1. API Key Modal
        const ApiKeyModal = ({ onSave, onClear, hasKey }) => {
            const [key, setKey] = useState("");
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState("");

            const check = async () => {
                if (!key.trim()) return;
                setLoading(true); setMsg("");
                try {
                    await testApiConnection(key.trim());
                    onSave(key.trim());
                } catch (e) {
                    setMsg("Key kh√¥ng h·ª£p l·ªá ho·∫∑c l·ªói m·∫°ng.");
                } finally { setLoading(false); }
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white p-6 rounded-lg max-w-md w-full shadow-xl">
                        <h2 className="text-xl font-bold mb-4">C√†i ƒë·∫∑t API Key</h2>
                        <p className="text-sm mb-2">L·∫•y key mi·ªÖn ph√≠ t·∫°i <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-blue-600 underline">Google AI Studio</a>.</p>
                        <input type="password" value={key} onChange={e => setKey(e.target.value)} className="w-full border p-2 rounded mb-2" placeholder="AIza..." />
                        {msg && <p className="text-red-500 text-sm mb-2">{msg}</p>}
                        <button onClick={check} disabled={loading} className="w-full bg-blue-600 text-white p-2 rounded font-bold">{loading ? "ƒêang ki·ªÉm tra..." : "L∆∞u Key"}</button>
                        {hasKey && <button onClick={onClear} className="w-full mt-2 text-red-500 text-sm">X√≥a Key c≈©</button>}
                    </div>
                </div>
            );
        };

        // 2. Student List
        const StudentList = ({ students, role, subjectName, onUpdate, onGenAll, onGenOne, onChangeSubject, onDelete, isGen }) => {
            const tableRef = useRef(null);
            
            const exportExcel = () => {
                const ws = XLSX.utils.json_to_sheet(students.map((s, i) => ({
                    STT: i + 1, 'H·ªç t√™n': s.name, 
                    'K·∫øt qu·∫£': role === TeacherRole.SUBJECT ? (s.subjectScore ?? s.subjectRating) : `${s.academicResult} - ${s.conductRating}`,
                    'Nh·∫≠n x√©t': s.comment
                })));
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "NhanXet");
                XLSX.writeFile(wb, "NhanXet.xlsx");
            };

            const exportPDF = async () => {
                if (!tableRef.current) return;
                const canvas = await html2canvas(tableRef.current);
                const pdf = new jsPDF('p', 'mm', 'a4');
                const w = pdf.internal.pageSize.getWidth();
                const h = (canvas.height * w) / canvas.width;
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, w, h);
                pdf.save("NhanXet.pdf");
            };

            return (
                <div className="bg-white rounded shadow border flex flex-col h-full overflow-hidden animate-fade-in">
                    <div className="p-4 border-b bg-slate-50 flex justify-between items-center flex-wrap gap-2">
                        <div className="flex gap-2 items-center">
                            <span className="font-bold">{students.length} HS</span>
                            {role === TeacherRole.SUBJECT && <select value={subjectName} onChange={e => onChangeSubject(e.target.value)} className="border rounded p-1"><option>To√°n</option><option>VƒÉn</option><option>KHTN</option><option>LS & ƒêL</option><option>Tin h·ªçc</option><option>Ng.ng·ªØ</option><option>GDCD</option><option>C.ngh·ªá</option><option>GDTC</option><option>Ngh·ªá thu·∫≠t</option><option>Kh√°c</option></select>}
                        </div>
                        <div className="flex gap-2">
                            <button onClick={onGenAll} disabled={isGen} className="bg-blue-600 text-white px-3 py-1 rounded font-bold disabled:opacity-50">{isGen ? "ƒêang t·∫°o..." : "T·∫°o l·∫°i h·∫øt"}</button>
                            <button onClick={exportExcel} className="border bg-white text-green-600 px-3 py-1 rounded font-bold">Excel</button>
                            <button onClick={exportPDF} className="border bg-white text-red-600 px-3 py-1 rounded font-bold">PDF</button>
                        </div>
                    </div>
                    <div className="overflow-auto p-4 flex-1" ref={tableRef}>
                        <table className="w-full text-left border-collapse border">
                            <thead className="bg-slate-100 text-xs font-bold uppercase sticky top-0">
                                <tr>
                                    <th className="p-2 border w-10">STT</th>
                                    <th className="p-2 border w-48">H·ªç t√™n</th>
                                    <th className="p-2 border w-24">K·∫øt qu·∫£</th>
                                    <th className="p-2 border">Nh·∫≠n x√©t</th>
                                    <th className="p-2 border w-20 text-center" data-html2canvas-ignore>T√°c v·ª•</th>
                                </tr>
                            </thead>
                            <tbody>
                                {students.map((s, i) => (
                                    <tr key={s.id} className="hover:bg-blue-50">
                                        <td className="p-2 border text-center">{i + 1}</td>
                                        <td className="p-2 border font-semibold">{s.name}</td>
                                        <td className="p-2 border text-sm">
                                            {role === TeacherRole.SUBJECT ? (s.subjectScore ?? s.subjectRating) : (
                                                <div className="text-xs">
                                                    <div>HT: {s.academicResult}</div>
                                                    <div>RL: {s.conductRating}</div>
                                                    {s.absences > 0 && <div className="text-red-500">Ngh·ªâ: {s.absences}</div>}
                                                </div>
                                            )}
                                        </td>
                                        <td className="p-2 border">
                                            {s.isProcessing ? <div className="h-8 bg-slate-200 animate-pulse rounded"></div> : 
                                            <textarea className="w-full h-full bg-transparent resize-none outline-none" rows={2} value={s.comment} onChange={e => onUpdate(s.id, {comment: e.target.value})} placeholder="..."></textarea>}
                                        </td>
                                        <td className="p-2 border text-center" data-html2canvas-ignore>
                                            <button onClick={() => onGenOne(s)} className="text-blue-600 p-1" title="T·∫°o l·∫°i">‚Ü∫</button>
                                            <button onClick={() => onDelete(s.id)} className="text-red-500 p-1" title="X√≥a">‚úï</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // 3. MAIN APP
        function App() {
            const [role, setRole] = useState(TeacherRole.SUBJECT);
            const [students, setStudents] = useState([]);
            const [subject, setSubject] = useState('To√°n');
            const [isGen, setIsGen] = useState(false);
            const [isRead, setIsRead] = useState(false);
            const [error, setError] = useState(null);
            const [status, setStatus] = useState("");
            const [showKey, setShowKey] = useState(false);

            useEffect(() => { if (!getStoredKey()) setShowKey(true); }, []);

            const updateStudent = (id, data) => setStudents(prev => prev.map(s => s.id === id ? {...s, ...data} : s));
            const deleteStudent = (id) => setStudents(prev => prev.filter(s => s.id !== id));

            const runAI = async (targets, sub) => {
                if (targets.length === 0) return;
                setIsGen(true); setError(null); setStatus("B·∫Øt ƒë·∫ßu...");
                setStudents(prev => prev.map(s => targets.find(t => t.id === s.id) ? {...s, isProcessing: true} : s));

                try {
                    const chunkSize = 5;
                    for (let i = 0; i < targets.length; i += chunkSize) {
                        const chunk = targets.slice(i, i + chunkSize);
                        setStatus(`ƒêang x·ª≠ l√Ω ${i+1}-${Math.min(i+chunkSize, targets.length)}...`);
                        
                        const map = await generateCommentsBatch(chunk, role, sub);
                        setStudents(prev => prev.map(s => map.has(s.id) ? {...s, comment: map.get(s.id), isProcessing: false} : (chunk.find(c => c.id === s.id) ? {...s, isProcessing: false} : s)));

                        if (i + chunkSize < targets.length) {
                            for (let t = 4; t > 0; t--) { setStatus(`Ngh·ªâ ${t}s (tr√°nh l·ªói Google)...`); await new Promise(r => setTimeout(r, 1000)); }
                        }
                    }
                    setStatus("");
                } catch (e) {
                    setError(e.message === "MISSING_API_KEY" ? "Thi·∫øu API Key" : e.message);
                    if (e.message === "MISSING_API_KEY") setShowKey(true);
                    setStudents(prev => prev.map(s => ({...s, isProcessing: false})));
                } finally { setIsGen(false); }
            };

            const handleFile = async (file) => {
                setError(null); setStudents([]);
                if (file.name.match(/\.xls|xlsx/)) {
                    const data = await file.arrayBuffer();
                    const res = parseExcelData(data, role);
                    if (res.students.length) {
                        setStudents(res.students);
                        if (res.detectedSubject) setSubject(res.detectedSubject);
                        runAI(res.students, res.detectedSubject || subject);
                    } else setError("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu Excel.");
                } else if (file.type.match(/image|pdf/)) {
                    setIsRead(true);
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        try {
                            const res = await extractDataFromMedia(reader.result.split(',')[1], file.type, role);
                            setStudents(res.students);
                            if (res.detectedSubject) setSubject(res.detectedSubject);
                            runAI(res.students, res.detectedSubject || subject);
                        } catch (e) { setError(e.message); }
                        setIsRead(false);
                    };
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="min-h-screen flex flex-col font-sans">
                    <header className="bg-white border-b h-14 flex items-center justify-between px-4 sticky top-0 z-20 shadow-sm">
                        <div className="flex items-center gap-2 font-bold text-lg text-slate-800">
                            <div className="bg-blue-600 text-white w-8 h-8 rounded flex items-center justify-center">AI</div>
                            Tr·ª£ l√Ω Nh·∫≠n x√©t
                        </div>
                        <div className="flex gap-2">
                            <div className="bg-slate-100 rounded p-1 flex">
                                <button onClick={() => {setRole(TeacherRole.SUBJECT); setStudents([]);}} className={`px-3 py-1 rounded text-sm font-bold ${role === TeacherRole.SUBJECT ? 'bg-white shadow text-blue-700' : 'text-slate-500'}`}>GVBM</button>
                                <button onClick={() => {setRole(TeacherRole.HOMEROOM); setStudents([]);}} className={`px-3 py-1 rounded text-sm font-bold ${role === TeacherRole.HOMEROOM ? 'bg-white shadow text-blue-700' : 'text-slate-500'}`}>GVCN</button>
                            </div>
                            <button onClick={() => setShowKey(true)} className="text-slate-400 hover:text-yellow-600">üîë</button>
                        </div>
                    </header>

                    <main className="flex-1 max-w-7xl w-full mx-auto p-4 flex flex-col gap-4">
                        {status && <div className="bg-blue-50 text-blue-700 p-2 rounded flex items-center gap-2 text-sm font-bold border border-blue-200"><span className="animate-spin">‚è≥</span> {status}</div>}
                        
                        {students.length === 0 ? (
                            <div className="bg-white rounded-xl shadow p-8 text-center border-2 border-dashed border-slate-300 hover:border-blue-400 transition-colors cursor-pointer relative">
                                <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={e => handleFile(e.target.files[0])} disabled={isRead} />
                                {isRead ? <div className="font-bold text-blue-600 animate-pulse">ƒêang ƒë·ªçc d·ªØ li·ªáu t·ª´ ·∫£nh...</div> : 
                                <div>
                                    <div className="text-4xl mb-2">üìÇ</div>
                                    <div className="font-bold text-slate-700">Ch·ªçn file Excel ho·∫∑c ·∫¢nh b·∫£ng ƒëi·ªÉm</div>
                                </div>}
                                {error && <div className="mt-4 text-red-600 bg-red-50 p-2 rounded">{error}</div>}
                            </div>
                        ) : (
                            <StudentList students={students} role={role} subjectName={subject} onUpdate={updateStudent} onGenOne={s => runAI([s], subject)} onGenAll={() => runAI(students, subject)} onChangeSubject={setSubject} onDelete={deleteStudent} isGen={isGen} />
                        )}
                    </main>

                    {showKey && <ApiKeyModal onSave={k => {localStorage.setItem('GEMINI_API_KEY', k); setShowKey(false);}} onClear={() => {localStorage.removeItem('GEMINI_API_KEY'); setShowKey(true);}} hasKey={!!getStoredKey()} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
