<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tr·ª£ l√Ω Nh·∫≠n x√©t H·ªçc b·∫°</title>
    
    <!-- 1. TH∆Ø VI·ªÜN C·∫¶N THI·∫æT -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- 2. STYLE T√ôY CH·ªàNH -->
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .cursor-wait { cursor: wait; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        /* T√πy ch·ªânh thanh cu·ªôn */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .loading-screen { 
            position: fixed; inset: 0; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; background: white; z-index: 50;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0;
            border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>

    <!-- 3. C·∫§U H√åNH API GENAI -->
    <script type="module">
        import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@0.1.1";
        window.GoogleGenAI = GoogleGenAI;
        window.GoogleGenAIType = Type;
    </script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.35.0",
    "xlsx": "https://esm.sh/xlsx@^0.18.5",
    "html2canvas": "https://esm.sh/html2canvas@^1.4.1",
    "jspdf": "https://esm.sh/jspdf@^4.0.0",
    "path": "https://esm.sh/path@^0.12.7",
    "vite": "https://esm.sh/vite@^7.3.1",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
</head>
<body>
    <div id="root">
        <div class="loading-screen">
            <div class="spinner"></div>
            <p style="margin-top: 15px; font-weight: 600; color: #64748b;">ƒêang t·∫£i ·ª©ng d·ª•ng...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const XLSX = window.XLSX;
        const html2canvas = window.html2canvas;
        const { jsPDF } = window.jspdf;

        // --- ENUMS & TYPES ---
        const TeacherRole = { SUBJECT: 'GVBM', HOMEROOM: 'GVCN' };
        const SUBJECTS = ["To√°n", "VƒÉn", "LS & ƒêL", "KHTN", "Tin h·ªçc", "Ng.ng·ªØ", "GDCD", "C.ngh·ªá", "GDTC", "Ngh·ªá thu·∫≠t", "NDGDCƒêP", "HƒêTN&HN", "Kh√°c ..."];

        // --- SERVICES: EXCEL ---
        const isNamePart = (val) => {
            if (typeof val !== 'string') return false;
            const str = val.trim();
            if (str.length === 0 || /\d/.test(str)) return false; 
            if (str.length < 2 && str.toUpperCase() !== '√ù') return false;
            const keywords = ['stt', 'h·ªç', 't√™n', 'th·ª©', 'ng√†y', 'th√°ng', 'nƒÉm', 'l·ªõp', 'tr∆∞·ªùng', 'ƒëi·ªÉm', 'k·∫øt', 'qu·∫£', 'h·ªçc', 'k·ª≥', 'm√¥n', 'gi√°o', 'vi√™n', 'tbm', 'ƒëtb', 'ubnd', 'thcs', 'thpt', 'ph√≤ng', 's·ªü', 'ƒë√†o', 't·∫°o', 'c·ªông', 'h√≤a', 'x√£', 'huy·ªán', 't·ªânh', 'th√†nh', 'ph·ªë', 'ƒë·ªôc', 'l·∫≠p', 's·ªë', 'l∆∞·ª£ng', 't·ªâ', 'l·ªá', 't·ªïng', 'sinh', 'ƒë·∫°t', 'ch∆∞a'];
            const lower = str.toLowerCase();
            if (keywords.some(k => lower === k)) return false; // Strict check for exact keywords
            if (['tr∆∞·ªùng', 'ph√≤ng', '·ªßy', 'ban', 'c·ªông h√≤a'].some(k => lower.includes(k))) return false;
            if (/^(T|K|TB|Y|G|ƒê|Cƒê|TX\d|HK\d)$/.test(str.toUpperCase())) return false;
            return true;
        };

        const detectSubject = (headers) => {
            const flat = headers.flat().join(' ').toLowerCase();
            if (flat.includes('to√°n')) return 'To√°n';
            if (flat.includes('vƒÉn') || flat.includes('vi·ªát') || flat.includes('ng·ªØ')) return 'VƒÉn';
            if (flat.includes('ls') || flat.includes('l·ªãch s·ª≠') || flat.includes('ƒë·ªãa')) return 'LS & ƒêL';
            if (flat.includes('khtn') || flat.includes('l√Ω') || flat.includes('h√≥a') || flat.includes('sinh')) return 'KHTN';
            if (flat.includes('tin')) return 'Tin h·ªçc';
            if (flat.includes('anh') || flat.includes('ngo·∫°i ng·ªØ')) return 'Ng.ng·ªØ';
            if (flat.includes('gdcd') || flat.includes('c√¥ng d√¢n')) return 'GDCD';
            if (flat.includes('c√¥ng ngh·ªá')) return 'C.ngh·ªá';
            if (flat.includes('th·ªÉ') || flat.includes('gdtc')) return 'GDTC';
            if (flat.includes('nh·∫°c') || flat.includes('m·ªπ') || flat.includes('ngh·ªá')) return 'Ngh·ªá thu·∫≠t';
            return undefined;
        };

        const parseExcelData = (fileData, role) => {
            try {
                let workbook = (typeof fileData === 'string') ? XLSX.read(fileData, { type: 'string' }) : XLSX.read(fileData, { type: 'array' });
                if (!workbook.SheetNames.length) return { students: [] };
                const ws = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                if (!rawData.length) return { students: [] };

                const detectedSubject = detectSubject(rawData.slice(0, 5));
                const students = [];

                rawData.forEach((row, rowIndex) => {
                    if (!Array.isArray(row) || row.length === 0) return;
                    let nameParts = [], nameEndIndex = -1;
                    const firstCell = row[0];
                    let hasIndex = typeof firstCell === 'number' || (typeof firstCell === 'string' && /^\d+$/.test(firstCell.trim()));

                    for (let i = 0; i < row.length; i++) {
                        const cell = row[i];
                        if (nameParts.length === 0 && hasIndex && i === 0) continue;
                        if (isNamePart(cell)) { nameParts.push(String(cell).trim()); nameEndIndex = i; }
                        else if (nameParts.length > 0 && (!cell || String(cell).trim() === '')) { 
                            if (!isNamePart(row[i+1])) break; 
                        } else if (nameParts.length > 0) break;
                    }

                    const fullName = nameParts.join(' ').trim();
                    if (!fullName || fullName.length < 2) if (fullName !== '√ù') return;
                    if (fullName.toUpperCase().includes("TR∆Ø·ªúNG") || fullName.toUpperCase().includes("THCS")) return;

                    let subjectScore, subjectRating, academicResult, conductRating, absences;
                    
                    if (role === TeacherRole.SUBJECT) {
                        for (let j = row.length - 1; j > nameEndIndex; j--) {
                            const cell = row[j];
                            if (cell == null || String(cell).trim() === '') continue;
                            const str = String(cell).trim().replace(',', '.');
                            const num = parseFloat(str);
                            if (!isNaN(num) && num >= 0 && num <= 10) { subjectScore = num; break; }
                            const upper = str.toUpperCase();
                            if (/^(T|K|ƒê|Cƒê|TB|G|Y|ƒê·∫†T|CH∆ØA ƒê·∫†T)$/.test(upper)) { subjectRating = upper; break; }
                        }
                    } else {
                        const ratings = [];
                        for (let j = nameEndIndex + 1; j < row.length; j++) {
                            const str = String(row[j] || '').trim().toUpperCase();
                            if (/^(T|K|ƒê|Cƒê|G|TB|Y|T·ªêT|KH√Å|ƒê·∫†T|CH∆ØA ƒê·∫†T|GI·ªéI|Y·∫æU|TRUNG B√åNH|K√âM)$/.test(str)) ratings.push(str);
                            else if (/^\d+$/.test(str)) { const n = parseInt(str); if (n >= 0 && n < 60) absences = n; }
                        }
                        if (ratings.length >= 1) academicResult = ratings[0];
                        if (ratings.length >= 2) conductRating = ratings[1];
                    }

                    if ((role === TeacherRole.SUBJECT && (subjectScore !== undefined || subjectRating)) || (role === TeacherRole.HOMEROOM && (academicResult || conductRating || absences))) {
                        students.push({
                            id: `xls-${Date.now()}-${rowIndex}`,
                            name: fullName,
                            comment: '',
                            isProcessing: false,
                            subjectScore, subjectRating, academicResult, conductRating, absences
                        });
                    }
                });
                return { students, detectedSubject };
            } catch (e) { console.error(e); return { students: [] }; }
        };

        // --- SERVICES: GEMINI AI ---
        const getAIClient = (key) => {
            if (!key) throw new Error("MISSING_API_KEY");
            if (!window.GoogleGenAI) throw new Error("ƒêang t·∫£i th∆∞ vi·ªán AI... Vui l√≤ng th·ª≠ l·∫°i sau gi√¢y l√°t.");
            return new window.GoogleGenAI({ apiKey: key });
        };

        const generateCommentsBatch = async (students, role, subjectName) => {
            const key = localStorage.getItem('GEMINI_API_KEY');
            const ai = getAIClient(key);
            // ∆Øu ti√™n model nhanh v√† ·ªïn ƒë·ªãnh
            const model = "gemini-2.0-flash"; 
            
            const wordLimit = role === TeacherRole.SUBJECT ? 12 : 20;
            let prompt = `B·∫°n l√† gi√°o vi√™n. Vi·∫øt nh·∫≠n x√©t ng·∫Øn g·ªçn (T·ªêI ƒêA ${wordLimit} t·ª´).`;
            if (role === TeacherRole.SUBJECT) {
                prompt += ` M√¥n ${subjectName}. Gi·ªèi/T·ªët (>=8): Khen nƒÉng l·ª±c. Kh√° (6.5-7.9): Khen c·ªë g·∫Øng. TB (5-6.4): Nh·∫Øc chƒÉm ch·ªâ. Y·∫øu (<5): Nh·∫Øc √¥n t·∫≠p.`;
            } else {
                prompt += ` GVCN. T·ªët: Khen ngoan. Kh√°: Khen ph·∫•n ƒë·∫•u. C·∫ßn c·ªë g·∫Øng: Nh·∫Øc nh·ªü. Chuy√™n c·∫ßn: Nh·∫Øc n·∫øu ngh·ªâ nhi·ªÅu.`;
            }

            const Type = window.GoogleGenAIType;
            const schema = {
                type: Type.ARRAY,
                items: {
                    type: Type.OBJECT,
                    properties: { id: { type: Type.STRING }, comment: { type: Type.STRING } },
                    required: ["id", "comment"]
                }
            };

            const payload = students.map(s => role === TeacherRole.SUBJECT 
                ? { id: s.id, name: s.name, result: s.subjectScore ?? s.subjectRating }
                : { id: s.id, name: s.name, kqht: s.academicResult, kqrl: s.conductRating, absences: s.absences }
            );

            // Retry logic ƒë∆°n gi·∫£n
            let retries = 3;
            while (retries > 0) {
                try {
                    const result = await ai.models.generateContent({
                        model,
                        contents: JSON.stringify(payload),
                        config: {
                            systemInstruction: prompt,
                            responseMimeType: "application/json",
                            responseSchema: schema,
                            safetySettings: [{ category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }]
                        }
                    });
                    const data = JSON.parse(result.text);
                    const map = new Map();
                    if (Array.isArray(data)) data.forEach(item => map.set(item.id, item.comment));
                    return map;
                } catch (e) {
                    if (e.message && e.message.includes("429")) {
                        retries--;
                        await new Promise(r => setTimeout(r, 2000)); // Wait 2s
                    } else {
                        throw e;
                    }
                }
            }
            throw new Error("Server qu√° t·∫£i. Vui l√≤ng th·ª≠ l·∫°i.");
        };

        const extractDataFromMedia = async (base64, mimeType, role) => {
            const key = localStorage.getItem('GEMINI_API_KEY');
            const ai = getAIClient(key);
            const model = "gemini-2.0-flash";
            
            const prompt = role === TeacherRole.SUBJECT 
                ? "Tr√≠ch xu·∫•t danh s√°ch h·ªçc sinh: H·ªç t√™n, ƒêi·ªÉm t·ªïng k·∫øt (ho·∫∑c x·∫øp lo·∫°i). JSON format."
                : "Tr√≠ch xu·∫•t danh s√°ch h·ªçc sinh: H·ªç t√™n, KQHT, KQRL, S·ªë ng√†y ngh·ªâ. JSON format.";
            
            const Type = window.GoogleGenAIType;
            const responseSchema = {
                type: Type.OBJECT,
                properties: {
                    subjectName: { type: Type.STRING, nullable: true },
                    students: {
                        type: Type.ARRAY,
                        items: {
                            type: Type.OBJECT,
                            properties: {
                                name: { type: Type.STRING },
                                score: { type: Type.NUMBER, nullable: true },
                                rating: { type: Type.STRING, nullable: true },
                                kqht: { type: Type.STRING, nullable: true },
                                kqrl: { type: Type.STRING, nullable: true },
                                absences: { type: Type.NUMBER, nullable: true }
                            },
                            required: ["name"]
                        }
                    }
                },
                required: ["students"]
            };

            const response = await ai.models.generateContent({
                model: model,
                contents: { parts: [{ inlineData: { mimeType, data: base64 } }, { text: prompt }] },
                config: { responseMimeType: "application/json", responseSchema: responseSchema }
            });
            
            const raw = JSON.parse(response.text);
            const students = (raw.students || []).map((item, idx) => ({
                id: `img-${Date.now()}-${idx}`,
                name: item.name,
                subjectScore: item.score,
                subjectRating: item.rating,
                academicResult: item.kqht,
                conductRating: item.kqrl,
                absences: item.absences,
                comment: '',
                isProcessing: false
            }));
            return { students, detectedSubject: raw.subjectName };
        };

        const testApiConnection = async (apiKey) => {
            const ai = new window.GoogleGenAI({ apiKey });
            await ai.models.generateContent({ model: "gemini-2.0-flash", contents: "Hi" });
        };

        // --- COMPONENT: API KEY MODAL ---
        const ApiKeyModal = ({ onSave, onClear, hasKey }) => {
            const [key, setKey] = useState("");
            const [status, setStatus] = useState("");
            const [loading, setLoading] = useState(false);

            const check = async () => {
                if (!key) return;
                setLoading(true); setStatus("");
                try {
                    await testApiConnection(key.trim());
                    onSave(key.trim());
                } catch (e) { setStatus("Key kh√¥ng h·ª£p l·ªá ho·∫∑c l·ªói m·∫°ng (429/400)."); }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-lg w-full relative">
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-3xl font-bold mx-auto mb-4">üîë</div>
                            <h2 className="text-2xl font-bold text-slate-800">C·∫•u h√¨nh API Key</h2>
                            <p className="text-slate-500 text-sm mt-2">M·ªói ng∆∞·ªùi d√πng c·∫ßn Key ri√™ng ƒë·ªÉ s·ª≠ d·ª•ng mi·ªÖn ph√≠.</p>
                        </div>
                        <div className="space-y-4">
                            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 text-sm text-slate-700">
                                <p className="font-bold mb-1">C√°ch l·∫•y Key (1 ph√∫t):</p>
                                <p>1. Truy c·∫≠p <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-blue-600 font-bold hover:underline">Google AI Studio</a>.</p>
                                <p>2. Nh·∫•n <b>Create API key</b>.</p>
                                <p>3. Copy m√£ b·∫Øt ƒë·∫ßu b·∫±ng <code>AIza...</code> d√°n v√†o d∆∞·ªõi.</p>
                            </div>
                            <input type="password" value={key} onChange={e => {setKey(e.target.value); setStatus('');}} onKeyDown={e => e.key==='Enter' && check()} placeholder="D√°n API Key v√†o ƒë√¢y..." className="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm" />
                            {status && <p className="text-red-500 text-sm font-medium">{status}</p>}
                            <div className="flex flex-col gap-2">
                                <button onClick={check} disabled={loading || !key} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-all shadow-lg disabled:opacity-50">
                                    {loading ? "ƒêang ki·ªÉm tra..." : "L∆∞u & B·∫Øt ƒë·∫ßu"}
                                </button>
                                {hasKey && <button onClick={() => {onClear(); setKey('');}} className="w-full py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm font-semibold transition-colors">X√≥a Key c≈©</button>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: STUDENT LIST ---
        const StudentList = ({ students, role, subjectName, onUpdate, onGenOne, onGenAll, onDelete, onChangeSubject, isGen }) => {
            const tableRef = useRef();
            const [colWidths, setColWidths] = useState({ stt: 50, name: 200, result: 150, comment: 400, action: 120 });
            const resizingRef = useRef(null);

            const startResize = (e, col) => {
                e.preventDefault();
                resizingRef.current = { col, startX: e.clientX, startWidth: colWidths[col] };
                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
            };
            const doResize = (e) => {
                if (!resizingRef.current) return;
                const { col, startX, startWidth } = resizingRef.current;
                setColWidths(prev => ({ ...prev, [col]: Math.max(50, startWidth + (e.clientX - startX)) }));
            };
            const stopResize = () => {
                resizingRef.current = null;
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
            };

            const exportExcel = () => {
                const ws = XLSX.utils.json_to_sheet(students.map((s, i) => ({
                    STT: i + 1, 'H·ªç t√™n': s.name, 'K·∫øt qu·∫£': role === TeacherRole.SUBJECT ? (s.subjectScore ?? s.subjectRating) : `${s.academicResult} - ${s.conductRating}`, 'Nh·∫≠n x√©t': s.comment
                })));
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "NhanXet");
                XLSX.writeFile(wb, "NhanXet.xlsx");
            };
            const exportPDF = async () => {
                if (!tableRef.current) return;
                const canvas = await html2canvas(tableRef.current, { scale: 2 });
                const pdf = new jsPDF('p', 'mm', 'a4');
                const w = pdf.internal.pageSize.getWidth();
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, w, (canvas.height * w) / canvas.width);
                pdf.save("NhanXet.pdf");
            };
            const exportImage = async () => {
                if (!tableRef.current) return;
                const canvas = await html2canvas(tableRef.current, { scale: 2 });
                const link = document.createElement('a'); link.download = "NhanXet.png"; link.href = canvas.toDataURL(); link.click();
            };

            const Resizer = ({ col }) => <div className="absolute right-0 top-0 h-full w-1 cursor-col-resize hover:bg-blue-500 z-10 opacity-0 hover:opacity-100" onMouseDown={e => startResize(e, col)} onClick={e => e.stopPropagation()}></div>;

            return (
                <div className="bg-white rounded-2xl shadow-xl border border-slate-200 flex flex-col h-full overflow-hidden animate-fade-in-up">
                    <div className="p-4 bg-slate-50/80 border-b flex flex-wrap items-center justify-between gap-4 backdrop-blur-sm">
                        <div className="flex items-center gap-4">
                            <span className="font-bold text-slate-800 flex items-center gap-2"><span className="bg-white px-2.5 py-0.5 rounded border shadow-sm">{students.length}</span><span className="text-slate-600">H·ªçc sinh</span></span>
                            {role === TeacherRole.SUBJECT && <div className="relative"><select value={subjectName} onChange={e => onChangeSubject(e.target.value)} className="appearance-none bg-white border border-slate-300 rounded-lg px-4 py-2 pr-8 font-semibold shadow-sm focus:ring-2 focus:ring-blue-500 outline-none"><option disabled value="">-Ch·ªçn m√¥n-</option>{SUBJECTS.map(s => <option key={s} value={s}>{s}</option>)}</select></div>}
                            {role === TeacherRole.HOMEROOM && <span className="px-3 py-1 bg-indigo-100 text-indigo-700 border border-indigo-200 rounded-full text-xs font-bold uppercase">Gi√°o vi√™n Ch·ªß nhi·ªám</span>}
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={onGenAll} disabled={isGen} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md shadow-blue-500/20 active:scale-95 disabled:opacity-70 disabled:cursor-wait transition-all">
                                {isGen ? <span className="animate-spin text-lg">‚Üª</span> : <span>‚ö°</span>} T·∫°o l·∫°i to√†n b·ªô
                            </button>
                            <div className="w-px h-8 bg-slate-200 mx-1"></div>
                            <div className="flex bg-white rounded-lg shadow-sm border border-slate-300 divide-x divide-slate-300 overflow-hidden">
                                <button onClick={exportExcel} className="px-3 py-2 hover:bg-slate-50 text-green-700 font-medium text-sm">Excel</button>
                                <button onClick={exportPDF} className="px-3 py-2 hover:bg-slate-50 text-red-700 font-medium text-sm">PDF</button>
                                <button onClick={exportImage} className="px-3 py-2 hover:bg-slate-50 text-blue-700 font-medium text-sm">·∫¢nh</button>
                            </div>
                        </div>
                    </div>
                    <div className="overflow-auto flex-1 p-4" ref={tableRef}>
                        <table className="w-full text-left border-collapse border border-slate-200 rounded-lg" style={{tableLayout: 'fixed'}}>
                            <thead className="bg-slate-50 text-slate-700 text-xs font-bold uppercase sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th className="p-4 border relative select-none" style={{width: colWidths.stt}}>STT <Resizer col="stt"/></th>
                                    <th className="p-4 border relative select-none" style={{width: colWidths.name}}>H·ªç v√† T√™n <Resizer col="name"/></th>
                                    <th className="p-4 border relative select-none" style={{width: colWidths.result}}>K·∫øt qu·∫£ <Resizer col="result"/></th>
                                    <th className="p-4 border relative select-none" style={{width: colWidths.comment}}>Nh·∫≠n x√©t <Resizer col="comment"/></th>
                                    <th className="p-4 border text-center relative select-none" style={{width: colWidths.action}} data-html2canvas-ignore>T√°c v·ª• <Resizer col="action"/></th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {students.map((s, i) => (
                                    <tr key={s.id} className="hover:bg-blue-50/50 transition-colors group">
                                        <td className="p-3 text-center text-slate-500 border font-mono text-sm">{i + 1}</td>
                                        <td className="p-3 font-semibold text-slate-800 border truncate" title={s.name}>{s.name}</td>
                                        <td className="p-3 text-sm border">
                                            {role === TeacherRole.SUBJECT ? <span className={`font-bold px-2 py-0.5 rounded ${s.subjectScore >= 8 || s.subjectRating === 'T' ? 'text-green-600 bg-green-50' : s.subjectScore < 5 ? 'text-red-500 bg-red-50' : 'text-slate-700'}`}>{s.subjectScore ?? s.subjectRating}</span> 
                                            : <div className="text-xs font-medium"><div className="flex gap-2">HT: <b className="text-slate-800">{s.academicResult}</b></div><div className="flex gap-2">RL: <b className="text-slate-600">{s.conductRating}</b></div>{s.absences > 0 && <span className="text-red-500 bg-red-50 px-1 rounded">Ngh·ªâ: {s.absences}</span>}</div>}
                                        </td>
                                        <td className="p-2 border relative align-top bg-white">
                                            {s.isProcessing ? <div className="animate-pulse space-y-2 p-1"><div className="h-3 bg-slate-200 rounded w-3/4"></div><div className="h-3 bg-slate-200 rounded w-1/2"></div></div> : 
                                            <textarea className="w-full h-full min-h-[44px] bg-transparent border-transparent hover:border-slate-200 focus:border-blue-400 rounded p-2 resize-none outline-none text-slate-800 leading-snug" value={s.comment} onChange={e => onUpdate(s.id, {comment: e.target.value})} placeholder="..."></textarea>}
                                        </td>
                                        <td className="p-2 border text-center align-middle" data-html2canvas-ignore>
                                            <div className="flex justify-center gap-1 opacity-40 group-hover:opacity-100 transition-opacity">
                                                <button onClick={() => onGenOne(s)} className="p-1.5 hover:bg-blue-50 text-blue-600 rounded" title="T·∫°o l·∫°i">‚Ü∫</button>
                                                <button onClick={() => onDelete(s.id)} className="p-1.5 hover:bg-red-50 text-red-500 rounded" title="X√≥a">‚úï</button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: APP ---
        function App() {
            const [role, setRole] = useState(TeacherRole.SUBJECT);
            const [students, setStudents] = useState([]);
            const [subject, setSubject] = useState('To√°n');
            const [isGen, setIsGen] = useState(false);
            const [isExtracting, setIsExtracting] = useState(false);
            const [status, setStatus] = useState("");
            const [showKey, setShowKey] = useState(false);
            const [error, setError] = useState("");
            const [isDragging, setIsDragging] = useState(false);

            useEffect(() => { if (!localStorage.getItem('GEMINI_API_KEY')) setShowKey(true); }, []);

            const updateStudent = (id, d) => setStudents(prev => prev.map(s => s.id === id ? {...s, ...d} : s));
            const deleteStudent = (id) => setStudents(prev => prev.filter(s => s.id !== id));

            const runAI = async (targets, sub) => {
                if (!targets.length) return;
                setIsGen(true); setError(""); setStatus("ƒêang x·ª≠ l√Ω...");
                setStudents(prev => prev.map(s => targets.find(t => t.id === s.id) ? {...s, isProcessing: true} : s));

                try {
                    const chunkSize = 5;
                    for (let i = 0; i < targets.length; i += chunkSize) {
                        const chunk = targets.slice(i, i + chunkSize);
                        setStatus(`ƒêang vi·∫øt nh·∫≠n x√©t nh√≥m ${i/chunkSize + 1}...`);
                        const map = await generateCommentsBatch(chunk, role, sub);
                        setStudents(prev => prev.map(s => map.has(s.id) ? {...s, comment: map.get(s.id), isProcessing: false} : (chunk.find(c => c.id === s.id) ? {...s, isProcessing: false} : s)));
                        if (i + chunkSize < targets.length) {
                            for (let t = 4; t > 0; t--) { setStatus(`Ngh·ªâ ${t}s ƒë·ªÉ Google kh√¥ng ch·∫∑n...`); await new Promise(r => setTimeout(r, 1000)); }
                        }
                    }
                    setStatus("");
                } catch (e) {
                    setError(e.message === "MISSING_API_KEY" ? "Thi·∫øu Key" : e.message);
                    if (e.message === "MISSING_API_KEY") setShowKey(true);
                    setStudents(prev => prev.map(s => ({...s, isProcessing: false})));
                } finally { setIsGen(false); }
            };

            const processFile = async (file) => {
                setError(""); setStudents([]);
                if (file.name.match(/\.xls|xlsx/)) {
                    const buf = await file.arrayBuffer();
                    const res = parseExcelData(buf, role);
                    if (res.students.length) {
                        setStudents(res.students);
                        if (res.detectedSubject) setSubject(res.detectedSubject);
                        runAI(res.students, res.detectedSubject || subject);
                    } else setError("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu Excel.");
                } else if (file.type.match(/image|pdf/)) {
                    setIsExtracting(true);
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        try {
                            const res = await extractDataFromMedia(reader.result.split(',')[1], file.type, role);
                            if(res.students.length) {
                                setStudents(res.students);
                                if (res.detectedSubject) setSubject(res.detectedSubject);
                                runAI(res.students, res.detectedSubject || subject);
                            } else setError("AI kh√¥ng t√¨m th·∫•y th√¥ng tin h·ªçc sinh trong ·∫£nh.");
                        } catch (e) { setError(e.message); if(e.message==="MISSING_API_KEY") setShowKey(true); }
                        setIsExtracting(false);
                    };
                    reader.readAsDataURL(file);
                } else { setError("ƒê·ªãnh d·∫°ng file kh√¥ng h·ªó tr·ª£."); }
            };

            return (
                <div className="min-h-screen flex flex-col font-sans bg-slate-50 selection:bg-blue-100">
                    <header className="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-30 shadow-sm">
                        <div className="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-9 h-9 bg-gradient-to-br from-blue-600 to-indigo-600 text-white rounded-lg flex items-center justify-center font-bold text-lg shadow-lg shadow-blue-500/20">AI</div>
                                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-slate-800 to-slate-600 tracking-tight hidden sm:block">Tr·ª£ l√Ω Nh·∫≠n x√©t H·ªçc b·∫°</h1>
                            </div>
                            <div className="flex gap-4 items-center">
                                <div className="flex items-center bg-slate-100 p-1 rounded-xl border border-slate-200 shadow-inner">
                                    <button onClick={() => { setRole(TeacherRole.SUBJECT); setStudents([]); }} className={`px-4 py-1.5 rounded-lg text-sm font-bold transition-all ${role === TeacherRole.SUBJECT ? 'bg-white text-blue-700 shadow-sm ring-1 ring-black/5' : 'text-slate-500 hover:text-slate-800'}`}>GVBM</button>
                                    <button onClick={() => { setRole(TeacherRole.HOMEROOM); setStudents([]); }} className={`px-4 py-1.5 rounded-lg text-sm font-bold transition-all ${role === TeacherRole.HOMEROOM ? 'bg-white text-blue-700 shadow-sm ring-1 ring-black/5' : 'text-slate-500 hover:text-slate-800'}`}>GVCN</button>
                                </div>
                                <button onClick={() => setShowKey(true)} className="text-slate-400 hover:text-yellow-600 p-2 rounded-full hover:bg-slate-100 transition-colors" title="C√†i ƒë·∫∑t Key">üîë</button>
                            </div>
                        </div>
                    </header>

                    <main className="flex-1 max-w-7xl w-full mx-auto px-6 py-8 flex flex-col gap-6">
                        {isGen && status && <div className="bg-white border border-blue-100 text-blue-700 px-4 py-3 rounded-xl flex items-center gap-3 shadow-lg shadow-blue-500/10 animate-fade-in"><span className="relative flex h-3 w-3"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span></span><span className="font-semibold text-sm">{status}</span></div>}
                        
                        {!students.length ? (
                            <section className="bg-white rounded-2xl shadow-xl border border-slate-200 p-8 animate-fade-in-up">
                                <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-3"><span className="w-8 h-8 rounded-full bg-blue-50 text-blue-600 text-sm font-bold flex items-center justify-center border border-blue-100">1</span> Nh·∫≠p d·ªØ li·ªáu</h2>
                                <div className="relative group" onDragOver={e=>{e.preventDefault();setIsDragging(true)}} onDragLeave={e=>{e.preventDefault();setIsDragging(false)}} onDrop={e=>{e.preventDefault();setIsDragging(false);if(e.dataTransfer.files[0])processFile(e.dataTransfer.files[0])}}>
                                    <label className={`flex flex-col items-center justify-center w-full h-64 border-2 border-dashed rounded-2xl cursor-pointer transition-all relative overflow-hidden ${isExtracting ? 'border-blue-300 bg-blue-50/50' : isDragging ? 'border-blue-500 bg-blue-50 scale-[1.02]' : 'border-slate-300 hover:border-blue-400 hover:bg-slate-50/80'}`}>
                                        <div className="flex flex-col items-center justify-center pt-5 pb-6 z-10 text-center px-4">
                                            {isExtracting ? <div><div className="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div><p className="text-lg font-bold text-slate-800">AI ƒëang ph√¢n t√≠ch ·∫£nh...</p></div> : 
                                            <>
                                                <div className="text-6xl mb-4 transition-transform group-hover:scale-110">üìÇ</div>
                                                <p className="text-lg text-slate-700 font-bold mb-2">{isDragging ? 'Th·∫£ file v√†o ƒë√¢y!' : 'K√©o th·∫£ file ho·∫∑c Click ƒë·ªÉ ch·ªçn'}</p>
                                                <p className="text-sm text-slate-500 font-medium">H·ªó tr·ª£ Excel, PDF, ·∫¢nh ch·ª•p b·∫£ng ƒëi·ªÉm</p>
                                            </>}
                                        </div>
                                        <input type="file" className="hidden" onChange={e => processFile(e.target.files[0])} accept=".xlsx,.xls,.pdf,image/*" disabled={isExtracting} />
                                    </label>
                                </div>
                                {error && <div className="mt-6 p-4 bg-red-50 border border-red-200 text-red-700 text-sm rounded-xl flex items-center gap-3 animate-fade-in"><span className="font-bold">‚ö† {error}</span></div>}
                            </section>
                        ) : (
                            <section className="flex-1 min-h-[500px] flex flex-col"><StudentList students={students} role={role} subjectName={subject} onUpdate={updateStudent} onGenOne={s => runAI([s], subject)} onGenAll={() => runAI(students, subject)} onDelete={deleteStudent} onChangeSubject={setSubject} isGen={isGen} /></section>
                        )}
                    </main>

                    {showKey && <ApiKeyModal onSave={k => {localStorage.setItem('GEMINI_API_KEY', k); setShowKey(false);}} onClear={() => {localStorage.removeItem('GEMINI_API_KEY'); setShowKey(true);}} hasKey={!!localStorage.getItem('GEMINI_API_KEY')} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
